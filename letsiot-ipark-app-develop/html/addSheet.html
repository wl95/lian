<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>新建工单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../fonts/iconfont/iconfont.css" rel="stylesheet" />
		<link href="../css/ipark.css" rel="stylesheet" />
		<style>
			html,body {
				height: 100%;
			}
			.mui-content {
    			background-color: inherit;
    		}
			.mui-input-group .mui-input-row {
				height: auto;
				color: #4D4D4D;
			}
			.mui-radio input[type=radio]{
				display: none;
			}
			.mui-radio label{
				padding:9px;
				text-align: center;
    			background: #fff;
				line-height: 1;
				width: 90px;
				color:#282828;
				border:1px solid #f0f0f0;
				border-radius: 35px;
			}
			.mui-radio label.active{
				border-color:#009e96;
				background-color: #acefe6;
			}
			.mui-radio.mui-left input[type=radio] {
				left: 0;
			}
			.mui-radio.mui-left label {
				padding-left:28px;
			}
			.mui-input-row span {
				line-height: 40px;
			}
			.mui-input-row span.form-full-span {
				display: inline-block;
			    height: 36px;
			    width: 100%;
			}
			.mui-input-row .iot-unit-span {
				margin-left: 5px;
				display: inline-block;
			}
			.mui-input-row .mui-textarea {
			    height: 120px;
			    display: inline-block;
			    margin: 10px 0px 0px;
			    font-size: 13px;
			    float: left;
			}
			.mui-input-row .textnum-tip{
				font-size: 13px;
			    color: #9E9E9E;
			    line-height: 25px;
			    height: 25px;
			    text-align: right;
			    clear: both;
			}
			.mui-input-row .textnum.error{
				color:#F17368;
			}
			.mui-input-group .mui-input {
		        height: 32px;
    			margin-top: 4px;
			}
			span.endTimeBtn .iconfont {
				color: #36C6D3;
				font-size: 20px;
			}
			.job-budgetTip{
				background-color: #FDF0DA;
				text-align: center;
				color: #666666;
				font-size: 14px;
			}
			.job-budgetTip span{
				line-height: 0;
			}
			.job-budgetTip span.dailyBudget{
				font-size: 17px;
			}
			.mui-img-list{
				margin-top: 13px;
				line-height: 0;
			}
			.mui-img-list a{
				display: inline-block;
				position: relative;
				line-height: 0;
				width: 28%;
				height: 69px;
				margin: 0 8px 8px 0;
			}
			.mui-img-list img{
				display: inline-block;
				width: 100%;
				height: 100%;
			}
			img.mui-img-uni{
				width: 23px;
				height: 23px;
				position: absolute;
				right: 0px;
			}
			.iconfont.icon-space{
				color:#686868;
				padding-left: 15px;
				padding-right: 6px;
			}
			.iconfont.important{
				font-size: 7px;
				color:#F17368;
				padding-left: 4px;
				position: absolute;
			}
			.unactive.newBtn{
				color:rgba(255,255,255,0.5);
			}
			.mui-img-upload{
				border-radius: 4px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">新建工单</h1>
		</header>
		<div class="mui-content my-sheet">
			<div id='backdrop'></div>
			<form class="mui-input-group" onsubmit="return false;">
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe67b;</span>类型<span class="iconfont important">&#xe677;</span>
					</label>
					<div class="mui-col-sm-35t mui-col-xs-12">
						<div class="mui-radio">
							<label for="normalSheet" id="normalSheetLabel" class="sheetText active">正常工单</label>
							<input id="normalSheet" name="type" type="radio" value="N">
						</div>
			        </div>
					<div class="mui-col-sm-35t mui-col-xs-12">
						<div class="mui-radio">
							<label for="disnormalSheet" id="disnormalSheetLabel" class="sheetText">紧急工单</label>
							<input id="disnormalSheet" name="type" type="radio" value="U">
						</div>
			        </div>
				</div>
				<div class="mui-row mui-input-row mui-hidden" id="endTimeRow">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe66d;</span>截止<span class="iconfont important">&#xe677;</span>
					</label>
					<div class="mui-col-sm-20t mui-col-xs-12">
						<span class="row-span form-full-span endTimeTrigger sheetText" id="endTimeInput" data-options='{"type":"time"}'></span>
			       	</div>
					<div class="mui-col-sm-10t mui-col-xs-12">
						<span class="endTimeBtn endTimeTrigger" data-options='{"type":"time"}'>
							<i class="iconfont ipark-edit"></i>
						</span>
			       </div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe665;</span>区域<span class="iconfont important">&#xe677;</span>
					</label>
					<div class="mui-col-sm-70t mui-col-xs-12" id='showAreaPicker'>
						<input type="hidden" name="areaValue" />
						<span class="mui-navigate-right sheetText" id="areaText">
							请选择项目区域
						</span>
			      	</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe67e;</span>动作<span class="iconfont important">&#xe677;</span>
					</label>
					<div class="mui-col-sm-70t mui-col-xs-12" id='showUserPicker'>
						<input type="hidden" name="actionValue" />
						<span class="mui-navigate-right sheetText" id="actionText">
							请选择养护动作
						</span>
			      	</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe670;</span>用工<span class="iconfont important">&#xe677;</span>
					</label>
					<div class="mui-col-sm-65t mui-col-xs-12">
						<input class="mui-input sheetText" placeholder="请输入预计用工人数" type="number" name="estimateLabor" id="estimateLabor" />
			      	</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe67c;</span>照片
					</label>
					<div class="mui-col-sm-65t mui-col-xs-12" id='showUserPicker'>
						<div id="imgList" class="mui-img-list">
							<a href="javascript:;" class="imageup">
								<img src="../images/upload.png"/>
							</a>
						</div>
			      	</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe67a;</span>说明
					</label>
					<div class="mui-col-sm-70t mui-col-xs-12 sheetText" style="padding-right:15px ;">
						<textarea class="mui-textarea" name="remark" rows="10" maxlength="250" placeholder="请输入养护说明（不超过250个字）"></textarea>
						<p class="textnum-tip"><span class="textnum">0</span>/250</p>
			      	</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-col-xs-12">
						<div id="job-budgetTip" class="job-budgetTip">当日预算：<span class="dailyBudget">0</span> 元； 人工单价：<span class="personAveragePrice">0</span>元/天</div>
			      	</div>
				</div>
			</form>
			<div class="mui-row mui-button-row" style="margin-top: 20px;">
				<button type="button" class="mui-btn mui-btn-primary unactive newBtn" id="submitBtn" onclick="return false">提 交</button>
			</div>
		</div>
		<script type="text/javascript" src="../js/jquery-1.8.0.min.js" ></script>
		<script src="../js/mui.min.js"></script>
    	<script src="../js/app.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="http://api.map.baidu.com/getscript?v=2.0&ak=A876b671f8466a2b8bcfbc202fe4bc73&services=&t=20180102152545"
        type="text/javascript"></script>
		<script type="text/javascript">
			(function($, doc) {
				$.init();
				var dailyBudget = 0;
                var personAveragePrice = 0; 
                var count = 0;
				window.addEventListener('resetPage',function(event){
					plus.webview.currentWebview().reload();
				});
				var type = 'N';
				$.ready(function(){
					//对textarea绑定输入文字长度检查
					jQuery("[name='remark']").on("input",function(){
						var number = jQuery(this).val().length;
						if(number == 250){
							jQuery('.textnum-tip .textnum').addClass('error').text(number);
						}else{
							jQuery('.textnum-tip .textnum').removeClass('error').text(number);
						}
					})
					//获取项目区域下拉列表
					Util.ajax({
						url: 'iparkProjectArea/getAll',
						data: {
							projectId:localStorage.getItem("IPARK_APP_PROJECTID")
						},
						success: function(data){
							var areaData = [], areaPicker = new $.PopPicker();
							for (var i = 0,len = data.length;i<len;i++) {
								areaData.push({
									value: data[i].id,
									text: data[i].areaName
								});
							}
							areaPicker.setData(areaData);
							doc.getElementById('showAreaPicker').addEventListener('tap', function(event) {
								areaPicker.show(function(items) {
									if(items[0].text==undefined){
										$("[name='assignValue']")[0].value = '';
									}else{
										$("[name='areaValue']")[0].value = items[0].value;
										$("#areaText")[0].innerText = items[0].text;
									}
								});
							}, false);
						}
					});
    				Util.ajax({
						url: 'maintAction/list',
						success: function(data){
							//下拉选择
							var actionData = [], userPicker = new $.PopPicker();
							for (var i = 0,len = data.content.length;i<len;i++) {
								actionData.push({
									value: data.content[i].id,
									text: data.content[i].name
								});
							}
							userPicker.setData(actionData);
							var showUserPickerButton = doc.getElementById('showUserPicker');
							showUserPickerButton.addEventListener('tap', function(event) {
								userPicker.show(function(items) {
									$("[name='actionValue']")[0].value = items[0].value;
									$("#actionText")[0].innerText = items[0].text;
								});
							}, false);
							
							//日期选择
							var result = $('#endTimeInput')[0];
							result.innerText = "23:59:00";
							result.setAttribute('vaue', '23:59');
							var btns = $('.endTimeTrigger');
							btns.each(function(i, btn) {
								btn.addEventListener('tap', function() {
									var _self = this;
									if(_self.picker) {
										_self.picker.show(function (rs) {
											result.innerText = rs.text+":00";
											result.setAttribute('vaue', rs.text);
											_self.picker.dispose();
											_self.picker = null;
										});
									} else {
										var optionsJson = this.getAttribute('data-options') || '{}';
										var options = JSON.parse(optionsJson);
										var id = this.getAttribute('id');
										_self.picker = new $.DtPicker(options);
										_self.picker.show(function(rs) {
											result.innerText = rs.text;
											result.setAttribute('vaue', rs.text);
											_self.picker.dispose();
											_self.picker = null;
										});
									}
									
								}, false);
							});
							
							$('input[name="type"]')[0].checked = true;
							
							var endTimeRow = doc.getElementById('endTimeRow');
							$('.mui-input-row').on('change', 'input[name="type"]',function() {
								if('N'==this.getAttribute("value")){
									type = 'N';
									endTimeRow.className = 'mui-row mui-input-row mui-hidden';
									jQuery("#normalSheetLabel").addClass('active');
									jQuery("#disnormalSheetLabel").removeClass('active');

								}else{
									type = 'U';
									endTimeRow.className = 'mui-row mui-input-row';
									jQuery("#normalSheetLabel").removeClass('active');
									jQuery("#disnormalSheetLabel").addClass('active');
								}
							}) 
						}
					});
					var projectId = localStorage.getItem("IPARK_APP_PROJECTID");
					Util.ajax({
						url: 'guideDay/getDayBudget',
						data: {
							projectId:projectId
						},
						success: function(data){
							console.log(JSON.stringify(data));
							jQuery('.dailyBudget').text(data.dailyBudget);
							jQuery('.personAveragePrice').text(data.personAveragePrice);
						}
					});
				});
				$.plusReady(function(){
					mui("body").on("tap",".imageup",function(){
		                page.imgUp();  
		            });
					var self = plus.webview.currentWebview();
					var projectId = localStorage.getItem("IPARK_APP_PROJECTID");
					var submitButton = doc.getElementById('submitBtn');
					submitButton.addEventListener('tap', function(event) {
						if(count == 0){
							count += 1;
						}else{
							return;
						}
						var url = 'workorderManage/createNormalWO';
						var dataIds = [];
						jQuery("img.mui-img-upload","#imgList").each(function(i){
							var id = jQuery(this).attr("id");
							dataIds.push(id);
						});
						var param = {
							"projectId": projectId,
							"projectArea": $("[name='areaValue']")[0].value,
							"maintAction": $("[name='actionValue']")[0].value,
							"remark": $("[name='remark']")[0].value,
							"estimateLabor": $("[name='estimateLabor']")[0].value,
							"imageList": dataIds
						};
						if(!param.projectArea){
							$.alert("项目区域不能为空");
							return;
						}
						if(!param.maintAction){
							$.alert("养护动作不能为空");
							return;
						}
						if(!param.remark){
							$.alert("养护说明不能为空");
							return;
						}else{
							var reg = /^(0|([1-9]\d*))(\.\d{1,1})?$/; 
			                if(param.estimateLabor<0){
			                    $.alert(new Error('用工数为有效的正数'));
			                    return;
			                }else if (!reg.test(param.estimateLabor)){
			                    $.alert(new Error('用工数为最多保留一位小数的有效正数'));
			                    return;
			                }
						}
						if('U' == type){
							url = 'workorderManage/createEmergencyWO';
							param.endTime = $('#endTimeInput')[0].getAttribute('vaue');
							if(!param.endTime){
								$.alert("截止时间不能为空");
								return;
							}
						}
						plus.nativeUI.showWaiting();
						Util.ajax({
							url: url,
							type: 'post',
							data: param,
							success: function(data){
								$.openWindow({
								    url: './actionResult.html', 
								    id:'actionResult',
								    extras:{
								    	actionId: '1'
								    }
								});
								setTimeout(function(){
									plus.nativeUI.closeWaiting();
								},800);
							},
							error: function(data){
								setTimeout(function(){
									mui.toast('网络异常，请稍后重试');
									plus.nativeUI.closeWaiting();
								},800);
							}
						});
					});		
				});
				var page=null;  
		        page={
		            imgUp:function(){  
		                var m=this;  
		                plus.nativeUI.actionSheet({cancel:"取消",buttons:[  
		                    {title:"拍照"},  
		                    {title:"从相册中选择"}  
		                ]}, function(e){//1 是拍照  2 从相册中选择  
		                    switch(e.index){  
		                        case 1:appendByCamera();break;  
		                        case 2:appendByGallery();break;  
		                    }
		                });
		            }
		        }  
		          
		        // 拍照添加文件
		        function appendByCamera(){
		            plus.camera.getCamera().captureImage(function(e){
		                console.log(e);
		                plus.io.resolveLocalFileSystemURL(e, function(entry) { 
		                	var path = entry.toLocalURL();
		                	baiduPosition(path);
		                }, function(e) { 
		                    mui.toast("读取拍照文件错误：" + e.message); 
		                }); 
		
		            });    
		        }
		        // 从相册添加文件
		        function appendByGallery(){
		            plus.gallery.pick(function(path){
		                //okdocument.getElementById("headimg").src = path;
		                baiduPosition(path);
		            });
		        }
	
				var lng = 0;
				var lat = 0;
		        // 上传文件
		        function upload(url){
		        	console.log(lng+","+lat);
		        	var server =  app.configures.URL + "/iPark/APIs/resources/uploadimage?type=WC&longitude="+lng+"&latitude="+lat;
		            var wt=plus.nativeUI.showWaiting();
		            var task=plus.uploader.createUpload(server,
		                {method:"POST"},
		                function(t,status){ //上传完成
		                    if(status==200){
		                    	var response = JSON.parse(t.responseText);
		                    	console.log(JSON.stringify(response));
		                    	var imgId = response.id;
		                    	var imgurl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMinimal;
		                    	var mediumImgUrl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMedium;
		                    	html = "<a class='imgItem' href='javascript:void(0);'><img class='mui-img-uni' src='../images/close.png'/><img class='mui-img-upload' id='"+imgId+"' data-src='"+mediumImgUrl+"' src='"+imgurl+"'/></a>";
		                        jQuery("#imgList").append(html);
		                        check();//检查上传图片的个数
		                        wt.close(); //关闭等待提示按钮
		                        jQuery(".mui-img-upload").off();
		                        jQuery(".mui-img-upload").on("click",function(){
									var src = jQuery(this).data('src');
									var result = "<img src='"+src+"'/>";
									jQuery("#backdrop").attr('class','mui-backdrop').html(result).show();
								});
								jQuery("#backdrop").off();
								jQuery("#backdrop").on("click",function(){
									jQuery("#backdrop").attr('class','').html('').hide();	
								});
		                    }else{
		                        alert("上传失败："+status);
		                        wt.close();//关闭等待提示按钮
		                    }
		                }
		            );
		            //添加其他参数
		            task.addData("name","file");
		            task.addFile(url,{key:"file"});
		            task.start();
		        }
		        function check(){
		        	var length = jQuery('#imgList').children('.imgItem').length;
	                if(length >= 5){
	                	jQuery('#imgList .imageup').hide();
	                }else{
	                	jQuery('#imgList .imageup').show();
	                }
		        }
		        
				
		        //获取经纬度
				function baiduPosition(path){
					plus.geolocation.getCurrentPosition(function(e){
		        		lng = e.coords.longitude;
					    lat = e.coords.latitude;
					    upload(path);
		        	}, function(e){
				 		var geolocation = new BMap.Geolocation();
					    geolocation.getCurrentPosition(function(r){
					        if(this.getStatus() == BMAP_STATUS_SUCCESS){
					        	lng = r.point.lng;
					        	lat = r.point.lat;
					        	upload(path);
					        }else {
					            mui.alert('获取位置失败,请确定您已开启定位服务');
					        }
					    },{enableHighAccuracy: true});
			        },{enableHighAccuracy:true,coordsType:'bd09ll',timeout:6000,maximumAge:5000,provider:'baidu'});
				    
				}
		        
		        jQuery('body').on('tap','.mui-img-uni',function(){
		        	jQuery(this).parent('.imgItem').remove();
		        	check();//检查上传图片的个数
		        });
			})(mui, document);
		</script>
	</body>
</html>