<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title>反馈工单</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" href="../css/mui.min.css"/>
	<link rel="stylesheet" href="../css/mui.picker.min.css"/>
	<link rel="stylesheet" href="../fonts/iconfont/iconfont.css"/>
	<link rel="stylesheet" href="../css/ipark.css"/>
	<style>
		html,body {
			height: 100%;
		}
		.mui-input-group .mui-input-row {
			height: auto;
			padding: 0 15px;
			margin-bottom: 0px;
		}
		.mui-input-row span {
			line-height: 50px;
		}
		.mui-input-row .action-span {
			padding-left: 27px;
		}
		#remark{width: 92%;display: inline-block;word-wrap: break-word;line-height: 20px;margin-top:11px;}
		#photoList img{
			display: inline-block;
			width: 60px;
			height: 60px;
			float: left;
			margin: 10px 10px 10px 0;
		}
		.iconfont.icon-space{
			color:#686868;
			vertical-align: middle;
			padding-left: 0px;
			padding-right: 6px;
		}
		.mui-content .sheetText.onlyRead{
			color:#282828;
		}
		.mui-input-group .mui-input-row:nth-last-child(3){
			margin-top: 10px;
		}
		.mui-input-row .mui-textarea{
	    	color:#282828;
		    height: 120px;
		    display: inline-block;
		    margin: 10px 0px 0px;
		    font-size: 13px;
		    float: left;
		}
		.mui-input-row .textnum-tip{
			font-size: 13px;
		    color: #9E9E9E;
		    line-height: 25px;
		    height: 25px;
		    text-align: right;
		    clear: both;
		    margin-bottom: 20px;
		}
		.mui-input-row .textnum.error{
			color:#F17368;
		}
		#callPhone{
			position: absolute;
			color:#009E96;
			font-size:22px;
			right: 0;
		}
		.writeOption{
			color:#009E96 !important;
		}
		.mui-navigate-right:after, .mui-push-right:after {
		    color: #009E96;
		}	
		.mui-img-list{
			line-height: 0;
		}
		.mui-img-list a{
			display: inline-block;
			position: relative;
			line-height:0;
			margin: 10px 10px 10px 0;
			width: 60px;
			height: 60px;
		}
		.mui-img-list img{
			display: inline-block;
			width:100%;
			height:100%;
		}
		img.mui-img-uni{
			width: 23px;
			height: 23px;
			position: absolute;
			right: 0px;
		}
		.mui-input-group .mui-input{
			height: 30px;
		}
		.iot-unit-span{
			padding-left: 5px;
			color:#282828;
			font-size: 14px;
		}
	</style>
</head>

<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">反馈工单</h1>
	</header>
	<div class="mui-content my-sheet">
		<div id='backdrop'></div>
		<div class="mui-content-padded" style="margin: 0;">
			<form class="mui-input-group" onsubmit="return false;">
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space">&#xe67b;</span>类型
						</label>
						<div class="mui-col-sm-70t mui-col-xs-12 sheetText onlyRead">
							<span id="sheetType"></span>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space">&#xe66d;</span>截止
						</label>
						<div class="mui-col-sm-20t mui-col-xs-12 sheetText onlyRead">
							<span id='endTime'><span>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space">&#xe665;</span>区域
						</label>
						<div class="mui-col-sm-70t mui-col-xs-12 sheetText onlyRead" id='showAreaPicker'>
							<input type="hidden" name="areaValue" />
							<span class="" id="areaText">
							</span>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space">&#xe67e;</span>动作
						</label>
						<div class="mui-col-sm-70t mui-col-xs-12 action-span-zcfz sheetText onlyRead">
							<input type="hidden" name="actionValue" />
							<span class="" id="actionText"></span>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row" style="display: none;">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space">&#xe67c;</span>照片
						</label>
						<div class="mui-col-sm-70t mui-col-xs-12">
							<div class="mui-img-list mui-limit-width" id="photoList"></div>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space">&#xe67a;</span>说明
					</label>
					<div class="mui-col-sm-70t mui-col-xs-12 action-span-zcfz sheetText onlyRead">
						<input type="hidden" name="actionValue" />
						<span class="" id="remark"></span>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space writeOption">&#xe670;</span>用工
						</label>
						<div class="mui-col-sm-20t mui-col-xs-12 sheetType ">
							<input class="mui-input" type="number" name="estimateLabor" id="estimateLabor" />
						</div><span class="iot-unit-span">人</span>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<div class="mui-row split-line">
						<label class="title-label">
							<span class="iconfont icon-space writeOption">&#xe67c;</span>照片
						</label>
						<div class="mui-col-sm-70t mui-col-xs-12" id='showUserPicker'>
							<div id="imgList" class="mui-img-list"><a href="javascript:;" class="imageup"><img src="../images/upload.png" /></a></div>
						</div>
					</div>
				</div>
				<div class="mui-row mui-input-row">
					<label class="title-label">
						<span class="iconfont icon-space writeOption">&#xe67a;</span>工单反馈
					</label>
					<div class="mui-col-sm-70t mui-col-xs-12 sheetText onlyRead">
						<textarea class="mui-textarea" name="remark" rows="10" maxlength="250" placeholder="请输入工单反馈（不超过250个字）"></textarea>
						<p class="textnum-tip"><span class="textnum">0</span>/250</p>
			      	</div>
				</div>
			</form>
			<div class="mui-row mui-button-row" style="margin:15px 0 20px;">
				<button type="button" class="mui-btn mui-btn-primary newBtn" id="submitBtn">提交</button>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/mui.picker.min.js"></script>
	<script type="text/javascript" src="../js/jquery-1.8.0.min.js"></script>
	<script type="text/javascript" src="../js/app.js"></script>
	<script type="text/javascript" src="../js/util.js"></script>
	<script src="http://api.map.baidu.com/getscript?v=2.0&ak=A876b671f8466a2b8bcfbc202fe4bc73&services=&t=20180102152545"
        type="text/javascript"></script>
	<script type="text/javascript">
		(function ($, doc) {
			$.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			var sheetId = "";
			window.addEventListener('resetPage', function (event) {
				plus.webview.currentWebview().reload();
			});
			
			window.addEventListener('assignSheetWithNewId', function (event) {
				sheetId = event.detail.sheetId;
				getWoInfo(sheetId);
			});

			var MIN_SOUND_TIME = 800;
			var recorder = null;
			var startTimestamp = null;
			var stopTimestamp = null;
			var stopTimer = null;
			var recordCancel = false;
			var audioPath = "";
			var soundAlert = document.getElementById("sound-alert");
			var audioTips = document.getElementById("audio-tips");

			// 控制录音弹出框是否播放
			var setSoundAlertVisable = function (show) {
				console.log("----------- show -------------")
				console.log(show);
				console.log("----------- show -------------")
			};

			mui.plusReady(function () {
				/**
				 * 录制语音文件转base64字符串
				 */
				// 按住录音（长按开始录音）
				document.querySelector('#recorder').addEventListener('hold', function () {
					recordCancel = false;
					if (stopTimer) clearTimeout(stopTimer);
					setSoundAlertVisable(true);
					// 获取当前设备的录音对象
					recorder = plus.audio.getRecorder();
					startTimestamp = (new Date()).getTime();
					recorder.record({
						filename: "_doc/audio/",
						format: "amr" //iOS平台支持"wav"、"aac"、"amr"格式，默认为"wav"
					}, function (path) {
						if (recordCancel) return;
						console.log("path:" + path);
						audioPath = path;
						//player(audioPath);
						uploadAudio(audioPath);
						//Audio2dataURL(path);
					}, function (e) {
						mui.toast("录音出现异常: " + e.message);
					});
				})

				// 释放保存（松手保存）
				document.querySelector('#recorder').addEventListener('release', function () {
					// 判断录音时间
					stopTimestamp = (new Date()).getTime();
					if (stopTimestamp - startTimestamp < 800) {
						audioTips.innerHTML = "录音时间太短";
						soundAlert.classList.add('rprogress-sigh');
						recordCancel = true;
						stopTimer = setTimeout(function () {
							setSoundAlertVisable(false);
						}, 800);
					} else {
						setSoundAlertVisable(false);
					}
					recorder.stop();
				})

				// 拖动屏幕（手指上划，取消发送）
				document.body.addEventListener('drag', function (event) {
					if (Math.abs(event.detail.deltaY) > 50) {
						if (!recordCancel) {
							recordCancel = true;
							if (!audioTips.classList.contains("cancel")) {
								audioTips.classList.add("cancel");
							}
							audioTips.innerHTML = "松开手指，取消发送";
						}
					} else {
						if (recordCancel) {
							recordCancel = false;
							if (audioTips.classList.contains("cancel")) {
								audioTips.classList.remove("cancel");
							}
							audioTips.innerHTML = "手指上划，取消发送";
						}
					}
				}, false);

				/**
				 * 录音语音文件转base64字符串
				 * @param {Object} path
				 */
				function Audio2dataURL(path) {
					plus.io.resolveLocalFileSystemURL(path, function (entry) {
						entry.file(function (file) {
							var reader = new plus.io.FileReader();
							reader.onloadend = function (e) {
								console.log(e.target.result);
							};
							reader.readAsDataURL(file);
						}, function (e) {
							mui.toast("读写出现异常: " + e.message);
						})
					})
				}


				function player(path) { //播放音乐 
					s = plus.audio.createPlayer(path);
					var num = s.getDuration(); //获取音频总长度number 
					setTimeout(function () { //延时获取，否则可能没有返回长度 
						var num = s.getDuration();
						alert(num)
					}, 100)

					s.play(function () { //播放完成回调 
						alert("Audio play success!");
					}, function (e) { //失败回调 
						alert("Audio play error: " + e.message);
					});
				}

				function uploadAudio(url) {
					//var server =  "http://10.0.2.253:19110/ipark4office/APIs/matterFeedback/voiceUpLoad";
					var server = app.configures.URL + "/ipark4office/APIs/matterFeedback/voiceUpLoad";
					var wait = plus.nativeUI.showWaiting();
					var a = plus.uploader.createUpload(server, {
							method: "POST"
						},
						function (t, status) { //上传完成
							console.log(status);
							wait.close(); //关闭等待提示按钮
							if (status == 200) {
								var response = JSON.parse(t.responseText);
								var url = response.filePath;
								console.log(url);
							} else {
								alert("语音上传失败,请稍后重试");
							}
						}
					);
					//添加其他参数
					a.addData("name", "file");
					a.addFile(url, {
						key: "file"
					});
					a.start();
				}
			})

			$.plusReady(function () {
				mui("body").on("tap", ".imageup", function () {
					page.imgUp();
				});
				var self = plus.webview.currentWebview();
				sheetId = self.sheetId;
				getWoInfo(sheetId);
			});
			
			$.ready(function () {
				//对textarea绑定输入文字长度检查
				jQuery("[name='remark']").on("input",function(){
					var number = jQuery(this).val().length;
					if(number == 250){
						jQuery('.textnum-tip .textnum').addClass('error').text(number);
					}else{
						jQuery('.textnum-tip .textnum').removeClass('error').text(number);
					}
				})
				
				document.getElementById('submitBtn').addEventListener('tap', function (event) {
					var url = 'workorderManage/feedbackWO';
					var dataIds = '';
					jQuery("img.mui-img-upload", "#imgList").each(function (i) {
						var id = jQuery(this).attr("id");
						if (i != 0) {
							dataIds += ",";
						}
						dataIds += id;
					});
					var number = $("[name='estimateLabor']")[0].value;
					var param = {
						id: sheetId,
						dataIds: dataIds,
						numberEmployment: parseFloat(number),
						backInfo: $("[name='remark']")[0].value,
						status: 'BP'
					};
					Util.ajax({
						url: url,
						type: 'post',
						data: param,
						success: function (data) {
							$.openWindow({
								url: './actionResult.html',
								id: 'actionResult',
								extras: {
									actionId: '14'
								}
							});
							self.close();
						}
					});
				});
			});

			function getWoInfo(sheetId) {
				Util.ajax({
					url: 'workorderManage/getWorkorderInfo',
					data: {
						id: sheetId
					},
					success: function (data) {
						//是否显示图片说明
						if ((null != data.images) && (data.images.length > 0)) {
							var imageArr = data.images;
							for (var i = 0; i < imageArr.length; i++) {
								var mediumSrc = "",src = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + imageArr[i].path;
								if(imageArr[i].resourceMinimal){
									src = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + imageArr[i].resourceMinimal;
									mediumSrc = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + imageArr[i].resourceMedium;
								}
								jQuery("#photoList").append("<img class='mui-img-upload' data-src='"+mediumSrc+"' src='" + src + "'/>");
							}
						} else {
							jQuery("#photoList").append("<p style='color:#282828;margin-bottom:0px;line-height:50px;font-size:14px'>无</p>");
						}
						jQuery(".mui-img-upload").on("click", function () {
							var src = jQuery(this).data('src');
							(src == "") && (src = jQuery(this).attr('src'))
							var result = "<img src='" + src + "'/>";
							jQuery("#backdrop").attr('class', 'mui-backdrop').html(result).show();
						});
						jQuery("#backdrop").on("click", function () {
							jQuery("#backdrop").attr('class', '').html('').hide();
						});
						jQuery("#photoList").parents('.mui-input-row').show();
						//工单的其他信息
						var woinfo = data;
						sheetId = woinfo.id;
						jQuery("#actionText")[0].innerText = data.maintActionName;
						jQuery("#sheetType").html(woinfo.woTypeStr);
						jQuery("#endTime").html(woinfo.endTime);
						jQuery("#maintActionName").text(woinfo.maintActionName);
						jQuery("#estimateLabor").text(woinfo.estimateLabor);
						jQuery('#remark').html(woinfo.remark);
						jQuery("#areaText").text(data.areaName || "暂未添加");
						/**/
					}
				});
			}

			var page = null;
			page = {
				imgUp: function () {
					var m = this;
					plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: [{
								title: "拍照"
							},
							{
								title: "从相册中选择"
							}
						]
					}, function (e) { //1 是拍照  2 从相册中选择  
						switch (e.index) {
							case 1:
								appendByCamera();
								break;
							case 2:
								appendByGallery();
								break;
						}
					});
				}
			}

			// 拍照添加文件
			function appendByCamera() {
				plus.camera.getCamera().captureImage(function (e) {
					console.log(e);
					plus.io.resolveLocalFileSystemURL(e, function (entry) {
						var path = entry.toLocalURL();
						baiduPosition(path);
					}, function (e) {
						mui.toast("读取拍照文件错误：" + e.message);
					});

				});
			}
			// 从相册添加文件
			function appendByGallery() {
				plus.gallery.pick(function (path) {
					//okdocument.getElementById("headimg").src = path;
					baiduPosition(path);
				});
			}
			
			var lng = 0;
			var lat = 0;
			// 上传文件
			function upload(url) {
				var server = app.configures.URL + "/iPark/APIs/resources/uploadimage?type=WBI&longitude="+lng+"&latitude="+lat;
				console.log(url);
				var wt = plus.nativeUI.showWaiting();
				var task = plus.uploader.createUpload(server, {
						method: "POST"
					},
					function (t, status) { //上传完成
						if (status == 200) {
							var response = JSON.parse(t.responseText);
							var imgId = response.id;
							var imgurl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMinimal;
		                    var mediumImgUrl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMedium;
							html ="<a class='imgItem' href='javascript:void(0);'>"
									+"<img class='mui-img-uni' src='../images/close.png'/>"
									+"<img class='mui-img-upload' id='" +imgId + "'  data-src='"+mediumImgUrl+"'  src='" + imgurl + "'/>"
								+"</a>";
							jQuery("#imgList").append(html);
							check(); //检查上传图片的个数
							wt.close(); //关闭等待提示按钮
							jQuery(".mui-img-upload").off();
							jQuery(".mui-img-upload").on("click", function () {
								var src = jQuery(this).data('src');
								var result = "<img src='" + src + "'/>";
								jQuery("#backdrop").attr('class', 'mui-backdrop').html(result).show();
							});
							jQuery("#backdrop").off();
							jQuery("#backdrop").on("click", function () {
								jQuery("#backdrop").attr('class', '').html('').hide();
							});
						} else {
							alert("上传失败：" + status);
							wt.close(); //关闭等待提示按钮
						}
					}
				);
				//添加其他参数
				task.addData("name", "file");
				task.addFile(url, {
					key: "file"
				});
				task.start();
			}

			function check() {
				var length = jQuery('#imgList').children('.imgItem').length;
				if (length >= 5) {
					jQuery('#imgList .imageup').hide();
				} else {
					jQuery('#imgList .imageup').show();
				}
			}
			
			//获取经纬度
			function baiduPosition(path){
				plus.geolocation.getCurrentPosition(function(e){
	        		lng = e.coords.longitude;
				    lat = e.coords.latitude;
				    upload(path);
	        	}, function(e){
			 		var geolocation = new BMap.Geolocation();
				    geolocation.getCurrentPosition(function(r){
				        if(this.getStatus() == BMAP_STATUS_SUCCESS){
				        	lng = r.point.lng;
				        	lat = r.point.lat;
				        	upload(path);
				        }else {
				            mui.alert('获取位置失败,请确定您已开启定位服务');
				        }
				    },{enableHighAccuracy: true});
		        },{enableHighAccuracy:true,coordsType:'bd09ll',timeout:6000,maximumAge:5000,provider:'baidu'});
			    
			}

			jQuery('body').on('tap', '.mui-img-uni', function () {
				jQuery(this).parent('.imgItem').remove();
				check(); //检查上传图片的个数
			});
		})(mui, document);
	</script>
</body>

</html>