<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>智 库</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/mui.picker.min.css">
    <link rel="stylesheet" href="../css/ipark.css">
    <link rel="stylesheet" href="../css/copy.css">
    <style>
        .mui-input-row.mui-input-range {
            padding-right: 7px;
        }

        .mui-input-range input[type=range] {
            height: 10px;
            border-radius: 10px;
            background-color: #009E96;
        }

        .mui-input-range .mui-tooltip {
            font-size: 16px;
            line-height: 142px;
            position: absolute;
            z-index: 1;
            top: -70px;
            width: 64px;
            height: 64px;
            text-align: center;
            opacity: 0.8;
            color: #009E96;
            border: none;
            border-radius: 0px;
            background-color: rgba(0, 0, 0, 0);
            text-shadow: none;
        }

        .mui-tooltip::after {
            content: '%';
        }

        .mui-input-range input[type='range']::-webkit-slider-thumb {
            width: 30px;
            height: 30px;
            border: 6px solid #009E96;
            border-radius: 50%;
            background-color: #C0FFEB;
            background-clip: padding-box;
            -webkit-appearance: none !important;
            z-index: 1;
            position: relative;
        }

        .mui-numbox .mui-input-numbox,
        .mui-numbox .mui-numbox-input {
            height: 150%;
            position: relative;
            top: -7px;
        }

        .mui-numbox {
            border: solid 1px #F2F2F2;
            width: 135px;
        }

        .mui-numbox [class*=btn-numbox],
        .mui-numbox [class*=numbox-btn] {
            color: #9E9E9E;
            background-color: #fff;
        }

        .mui-numbox .mui-input-numbox,
        .mui-numbox .mui-numbox-input {
            border-right: solid 1px #F2F2F2 !important;
            border-left: solid 1px #F2F2F2 !important;
        }

        .mui-hidden {
            display: block !important;
        }

        .item,
        .otherItem,
        .defultItem {
            background-color: #fff;
            min-height: 50px;
            line-height: 50px;
            padding: 0 15px;
            font-size: 14px;
            color: #282828;
            margin-top: 15px;
            overflow: hidden;
        }

        .costContainer {
            padding-top: 67px;
        }

        .item:nth-child(1) {
            margin-top: 0;
        }

        .item>.item-left-title {
            float: left;
        }

        .item>.item-right-content {
            float: right;
        }

        .rmbSymbol {
            font-size: 10px;
            color: #F17368;
        }

        .rmbValue {
            color: #F17368;
        }

        .unactiveArrow {
            color: #D1D1D1;
            font-size: 10px;
            width: 50px;
            display: inline-block;
        }

        .rightArrow {
            color: #D1D1D1;
            font-size: 14px;
            display: inline-block;
            width: 100%;
            height: 100%;
        }

        .title {
            overflow: hidden;
        }

        .titleWord {
            color: #686868;
            float: left;
            min-width: 40px;
        }

        .titleArrow {
            width: 50px;
            float: right;
            text-align: right;
        }

        .item>.content-item:nth-of-type(2) {
            margin-top: -20px;
        }

        .otherItem>.content-item:nth-of-type(2) {
            margin-top: -10px;
        }

        .content-item {
            border-bottom: 1px dashed #E6F1F2;
            min-height: 45px;
            overflow: hidden;
        }

        .progressContent {
            height: 100px;
        }

        .flexBox, .flexBoxSecond {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coverContent {
            width: 100%;
            height: 10px;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            position: relative;
            float: right;
            top: -30px;
            z-index: 0;
            background-color: #C0FFEB;
        }

        .addMore,
        .addOhters {
            height: 30px;
            line-height: 30px;
            text-align: center;
            color: #009E96;
            font-size: 12px;
            display: none;
            border-top: 1px dashed #E6F1F2;
        }

        textarea {
            font-size: 13px;
            border: none;
            padding: 10px 0;
            height: 60px;
            margin-bottom: 0;
            color: #282828;
        }

        .defultItem textarea {
            height: 90px;
        }

        .textareaContainer {
            line-height: 0;
        }


        textarea::-webkit-input-placeholder {
            color: #9E9E9E;
        }

        textarea:-moz-placeholder {
            color: #9E9E9E;
        }

        textarea::-moz-placeholder {
            color: #9E9E9E;
        }

        textarea::-ms-input-placeholder {
            color: #9E9E9E;
        }

        .mui-row {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #fff !important;
            font-size: 14px;
            min-height: 70px;
            line-height: 70px;
        }

        #IMG {
            padding-left: 40px;
        }

        #IMG,
        #imgList {
            display: block;
            width: 100%;
        }

        .imgItem {
            margin-right: 5px;
        }

        .photoName {
            height: 100%;
        }

        .subContainer {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .topTotal {
            position: fixed;
            top: 64px;
            z-index: 99;
            width: 100%;
            border-bottom: #e6f1f2 1px solid;
        }
    </style>
</head>

<body>
    <header class="mui-bar mui-bar-nav">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 id="title" class="mui-title">新建日报</h1>
    </header>
    <div id='backdrop'></div>
    <div class="mui-content">
        <div class="item topTotal">
            <div class="item-left-title">
                <span id="whichDate">提交今日</span>
                <span class="unactiveArrow">&nbsp;&nbsp;∨</span>
            </div>
            <div class="item-right-content">
                合计：<span class="rmbSymbol">￥</span><span class="rmbValue" id="allCost">0</span>
            </div>
        </div>

        <div class="costContainer">
            
        </div>

        <div class="otherContainer">
            <div class="otherItem">
                <div class="title">
                    <div class="titleWord problemItem">人员</div>
                    <div class="titleArrow"><span class="rightArrow problemArrow">></span></div>
                </div>
                <div class="content-item textareaContainer" style="border: none;">
                    <textarea name="" id="" placeholder="请输入问题点与分析" maxlength="100"></textarea>
                </div>
                <div class="addOhters">继续添加</div>
            </div>
        </div>

        <div class="mui-row mui-input-row">
            <div class="titleWord photoName">照片</div>
            <div id='IMG'>
                <div id="imgList" class="mui-img-list">
                    <a href="javascript:;" class="imageup">
                        <img src="../images/upload.png" />
                    </a>
                </div>
            </div>
        </div>

        <div class="defultItem">
            <div class="content-item textareaContainer" style="border: none;">
                <textarea name="" id="safeRecord" placeholder="请输入安全文明施工记录" maxlength="100"></textarea>
            </div>
        </div>
        <div class="defultItem">
            <div class="content-item textareaContainer" style="border: none;">
                <textarea name="" id="tomorrowPlan" placeholder="请输入明日计划" maxlength="100"></textarea>
            </div>
        </div>
        <div class="subContainer">
            <button type="button" class="mui-btn mui-btn-primary unactive newBtn" id="submitBtn" onclick="return false">提 交</button>
        </div>
    </div>
    <script src="../js/mui.min.js"></script>
    <script src="../js/mui.picker.min.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/util.js"></script>
    <script src="../js/jquery-1.8.0.min.js"></script>
    <script>
        var projectId = localStorage.getItem("IPARK_APP_PROJECTID");
        console.log(projectId);

        var sign = 0;
        var myArr = [];
        var myArrMirror = [];
        var myArrMirrorMirror = [];
        var problemArr = [
            {
                text: '人员',
                value: 0
            },
            {
                text: '机械',
                value: 1
            },
            {
                text: '材料',
                value: 2
            }
        ];
        var isyesterday = false;

        // 添加更多事件
        $('.addOhters').on('tap', function () {
            addOhtersMore();
        });
        // 右侧箭头事件
        $('.problemArrow').on('tap', function () {
            addOhtersMore(this);
        });
        // 选择提交今日或昨日日报
        $('.unactiveArrow').on('tap', function () {
            var that = this;
            that.picker = new mui.PopPicker();
            that.picker.setData([
                {
                    value: "1",
                    text: "提交今日",
                }, {
                    value: "2",
                    text: "补填昨日"
                }
            ]);
            that.picker.pickers[0].setSelectedIndex(1, 1000);
            that.picker.show(function (selectedItem) {
                $('#whichDate').text(selectedItem[0].text);
                if (selectedItem[0].value == '1') {
                    isyesterday = false;
                } else if (selectedItem[0].value == '2') {
                    isyesterday = true;
                }
                console.log(isyesterday);
            })
        })

        // 显示 -- 添加更多
        function showAddMore() {
            var item = $('.item');
            for (var i = 0; i < item.length; i++) {
                $(item[i]).find('.addMore').css({
                    display: 'none'
                })
            }
            $(item[item.length - 1]).find('.addMore').css({
                display: 'block'
            })
            var otherItem = $('.otherItem');
            for (var i = 0; i < otherItem.length; i++) {
                $(otherItem[i]).find('.addOhters').css({
                    display: 'none'
                })
            }
            $(otherItem[otherItem.length - 1]).find('.addOhters').css({
                display: 'block'
            })
            checkProblemArr();
            checkMyArr();
        }

        // 问题继续添加
        function addOhtersMore(arrowflag) {
            checkProblemArr();
            if (problemArr.length != 0) {
                var that = this;
                that.picker = new mui.PopPicker();
                that.picker.setData(problemArr);
                that.picker.show(function (selectedItem) {
                    if (arrowflag) {
                        var parent = $(arrowflag).parent().parent().parent();
                        var textAreaId = '';
                        if (selectedItem[0].text == '人员') {
                            textValue = '人员';
                            textAreaId = 'p';
                        }
                        if (selectedItem[0].text == '机械') {
                            textValue = '机械';
                            textAreaId = 'm';
                        }
                        if (selectedItem[0].text == '材料') {
                            textValue = '材料';
                            textAreaId = 's';
                        }
                        parent.html(
                            '                <div class="title">'+
                            '                    <div class="titleWord problemItem">' + textValue + '</div>'+
                            '                    <div class="titleArrow"><span class="rightArrow problemArrow problemArrow' + sign + '">></span></div>'+
                            '                </div>'+
                            '                <div class="content-item textareaContainer" style="border: none;">'+
                            '                    <textarea name="" id="' + textAreaId + '" placeholder="请输入问题点与分析" maxlength="100"></textarea>'+
                            '                </div>'+
                            '                <div class="addOhters addOhters' + sign + '">继续添加</div>'
                        )
                        showAddMore();
                        // 添加更多事件
                        $('.addOhters' + sign).on('tap', function () {
                            addOhtersMore();
                        });
                        // 右侧箭头事件
                        $('.problemArrow' + sign).on('tap', function () {
                            addOhtersMore(this);
                        });
                        sign ++;
                    } else {
                        addProblemItem(selectedItem[0].text);
                    }
                })
            }
        }

        // 添加问题条目
        function addProblemItem(text) {
            var textValue = '';
            var textAreaId = '';
            if (text == '人员') {
                textValue = '人员';
                textAreaId = 'p';
            }
            if (text == '机械') {
                textValue = '机械';
                textAreaId = 'm';
            }
            if (text == '材料') {
                textValue = '材料';
                textAreaId = 's';
            }
            $(  '            <div class="otherItem">'+
                '                <div class="title">'+
                '                    <div class="titleWord problemItem">' + textValue + '</div>'+
                '                    <div class="titleArrow"><span class="rightArrow problemArrow problemArrow' + sign + '">></span></div>'+
                '                </div>'+
                '                <div class="content-item textareaContainer" style="border: none;">'+
                '                    <textarea name="" id="' + textAreaId + '" placeholder="请输入问题点与分析" maxlength="100"></textarea>'+
                '                </div>'+
                '                <div class="addOhters addOhters' + sign + '">继续添加</div>'+
                '            </div>'
            ).appendTo($('.otherContainer'));
            
            showAddMore();
            checkProblemArr();
            // 添加更多事件
            $('.addOhters' + sign).on('tap', function () {
                addOhtersMore();
            });
            // 右侧箭头事件
            $('.problemArrow' + sign).on('tap', function () {
                addOhtersMore(this);
            });
            sign ++;
        }

        // 动态修改problemArr
        function checkProblemArr() {
            problemArr = [
                {
                    text: '人员',
                    value: 0
                },
                {
                    text: '机械',
                    value: 1
                },
                {
                    text: '材料',
                    value: 2
                }
            ];
            var problemItem = $('.problemItem');
            for (var i = 0; i < problemItem.length; i++) {
                for (var j = 0; j < problemArr.length; j++) {
                    if (problemArr[j].text == $(problemItem[i]).text()) {
                        removeByValue(problemArr, problemArr[j]);
                    }
                }
            }
            var otherItem = $('.otherItem');
            var problemArrow = $('.problemArrow');
            if (problemArr.length == 0) {
                for (var i = 0; i < otherItem.length; i++) {
                    $(otherItem[i]).find('.addOhters').css({
                        display: 'none'
                    })
                }
                for (var i = 0; i < problemArrow.length; i++) {
                    $(problemArrow[i]).css({
                        display: 'none'
                    })
                }
            }
        }

        // 动态修改myArr
        function checkMyArr() {
            var costsName = $('.costsName');
            for (var i = 0; i < costsName.length; i++) {
                for (var j = 0; j < myArr.length; j++) {
                    if (myArr[j].text == $(costsName[i]).text()) {
                        removeByValue(myArr, myArr[j]);
                    }
                }
            }
            var item = $('.costContainer .item');
            var costArrow = $('.costArrow');
            if (myArr.length == 0) {
                for (var i = 0; i < item.length; i++) {
                    $(item[i]).find('.addMore').css({
                        display: 'none'
                    })
                }
                for (var i = 0; i < costArrow.length; i++) {
                    $(costArrow[i]).css({
                        display: 'none'
                    })
                }
            } else {
                for (var i = 0; i < costArrow.length; i++) {
                    $(costArrow[i]).css({
                        display: 'block'
                    })
                }
                for (var i = 0; i < item.length; i++) {
                    $(item[i]).find('.addMore').css({
                        display: 'none'
                    })
                }
                $(item[item.length - 1]).find('.addMore').css({
                    display: 'block'
                })
            }
        }

        // numbox改变时修改myArr
        function changeMyArr() {
            var costsName = $('.costsName');
            for (var i = 0; i < costsName.length; i++) {
                for (var j = 0; j < myArrMirror.length; j++) {
                    if (myArrMirror[j].text == $(costsName[i]).text()) {
                        removeByValue(myArrMirror, myArrMirror[j]);
                    }
                }
            }
            myArr = JSON.parse(JSON.stringify(myArrMirror));
            myArrMirror = JSON.parse(JSON.stringify(myArrMirrorMirror));
            var item = $('.costContainer .item');
            var costArrow = $('.costArrow');
            if (myArr.length == 0) {
                for (var i = 0; i < item.length; i++) {
                    $(item[i]).find('.addMore').css({
                        display: 'none'
                    })
                }
                for (var i = 0; i < costArrow.length; i++) {
                    $(costArrow[i]).css({
                        display: 'none'
                    })
                }
            } else {
                for (var i = 0; i < costArrow.length; i++) {
                    $(costArrow[i]).css({
                        display: 'block'
                    })
                }
                for (var i = 0; i < item.length; i++) {
                    $(item[i]).find('.addMore').css({
                        display: 'none'
                    })
                }
                $(item[item.length - 1]).find('.addMore').css({
                    display: 'block'
                })
            }
        }

        // 计算合计总价
        function calcAllCost() {
            var arr = $('.itemCost');
            var total = 0;
            for (var i = 0; i < arr.length; i++) {
                total = floatAdd(total, $(arr[i]).text() * 1);
            }
            $('#allCost').text(total);
        }


        mui.plusReady(function () {
            // 构建myArr数组
            Util.ajax({
                url: '/daily/getcostsitem',
                async: false,
                data: {
                    projectId: projectId
                },
                success: function (res) {
                    // 构建数组
                    for (var k = 0; k < res.length; k++) {
                        if (res[k].costsId * 1 != 0) {
                            myArr.push({
                                text: res[k].name,
                                value: res[k].costsId
                            })
                            myArrMirror.push({
                                text: res[k].name,
                                value: res[k].costsId
                            })
                            myArrMirrorMirror.push({
                                text: res[k].name,
                                value: res[k].costsId
                            })
                        }
                    }
                }
            })

            // ajax判断是否昨日已填
            Util.ajax({
                url: '/daily/isexistsyesterdaydaily',
                data: {
                    projectId: projectId
                },
                success: function (res) {
                    // console.log(res);
                    if (res == false) {
                        $('.unactiveArrow').css({
                            display: 'inline-block'
                        })
                    } else {
                        $('.unactiveArrow').css({
                            display: 'none'
                        })
                    }
                }
            })

            // 初始化进度条
            function initProgress(domId) {
                $(domId).append($('<span class="mui-tooltip mui-hidden" style="left: -18px;">0</span>'));
                $(domId).bind('input porpertychange', function (e) {
                    var val = Number($(domId + ' input').val());
                    $(domId + 'coverContent').css({
                        width: 'calc(100% - ' + val + '%)'
                    })
                    $(domId + ' span').text(val);
                    $(domId + ' span').css({
                        left: 3.1 * val - 18 + 'px'
                    })
                    // console.log(val);
                });
            }

            // 添加更多 -- 费用
            function addMore() {
                var that = this;
                that.picker = new mui.PopPicker();
                that.picker.setData(myArr);
                that.picker.show(function (selectedItem) {
                    addCostList(selectedItem[0].value);
                })
            }

            // 添加费用单条项
            function addCostList(id) {
                Util.ajax({
                    url: '/daily/getcostsitembycostsid',
                    data: {
                        costsId: id,
                        projectId: projectId
                    },
                    success: function (res) {
                        console.log(JSON.stringify(res))
                        // 用工
                        if (res.type * 1 == 0 || res.type * 1 == 1) {
                            remark = res.remark ? res.remark : '';
                            $(  
                                '            <div class="item" id="item' + res.costsId + '">' + 
                                '                <div class="title">' + 
                                '                    <div class="titleWord costsName">' + res.name + '</div>' + 
                                '                    <div class="titleArrow"><span id=' + res.costsId + ' class="rightArrow costArrow costArrow' + sign + '">></span></div>' + 
                                '                </div>' + 
                                '                <div class="content-item flexBox">' + 
                                '                    <div class="titleWord">' + 
                                '                        <span class="rmbSymbol">￥</span><span class="rmbValue itemCost" id="totalPrice' + res.costsId + '">' + 1 * (res.price * 1) + '</span>' + 
                                '                    </div>' + 
                                '                    <div class="mui-numbox" data-numbox-step="0.5" data-numbox-min="0" data-numbox-max="999">' + 
                                '                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>' + 
                                '                        <input class="mui-numbox-input" type="number" value="' + 1 + '" id="numBoxVal' + res.costsId + '">' + 
                                '                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>' + 
                                '                    </div>' + 
                                '                </div>' + 
                                '                <div class="content-item progressContent">' + 
                                '                    <div class="titleWord">完成情况</div>' + 
                                '                    <div class="mui-input-row mui-input-range" id="myProgress' + res.costsId + '">' + 
                                '                        <input type="range" min="0" max="100" value="0">' + 
                                '                        <div class="coverContent" id="myProgress' + res.costsId + 'coverContent"></div>' + 
                                '                    </div>' + 
                                '                </div>' + 
                                '                <div class="content-item" style="border: none;">' + 
                                '                    <div class="content-item textareaContainer" style="border: none;">' + 
                                '                        <textarea name="" id="" placeholder="请输入工单任务说明" maxlength="100">' + remark + '</textarea>' + 
                                '                    </div>' + 
                                '                </div>' + 
                                '                <div class="addMore addMore' + sign + '">继续添加</div>' + 
                                '            </div>'
                            ).appendTo($('.costContainer'));

                            // 初始化进度条
                            initProgress('#myProgress' + res.costsId);

                            // 初始化numbox
                            mui('.mui-numbox').numbox();

                            // numbox数值改变逻辑
                            $('#numBoxVal' + res.costsId).on('change', function () {
                                var val = $('#numBoxVal' + res.costsId).val();

                                if (val == 0) {
                                    $('#item' + res.costsId).remove();
                                }

                                $('#totalPrice' + res.costsId).text(floatMul(val, res.price * 1));
                                calcAllCost();
                                showAddMore();
                                changeMyArr();
                            }); 

                            // 添加更多事件
                            $('.addMore' + sign).on('tap', function () {
                                addMore();
                            });
                            // 右侧箭头切换事件
                            $('.costArrow' + sign).on('tap', function () {
                                var id = $(this).attr('id');
                                changeCostsItem(this);
                            });
                            sign ++;
                        }
                        
                        // 机械 & 材料
                        if (res.type * 1 == 2 || res.type * 1 == 3) {
                            remark = res.remark ? res.remark : '';
                            $(  
                                '            <div class="item" id="item' + res.costsId + '">' + 
                                '                <div class="title">' + 
                                '                    <div class="titleWord costsName">' + res.name + '</div>' + 
                                '                    <div class="titleArrow"><span id=' + res.costsId + ' class="rightArrow costArrow costArrow' + sign + '">></span></div>' + 
                                '                </div>' + 
                                '                <div class="content-item flexBoxSecond">' + 
                                '                    <div class="titleWord">' + 
                                '                        <span class="rmbSymbol">￥</span><span class="rmbValue itemCost" id="totalPrice' + res.costsId + '">' + 1 * (res.price * 1) + '</span>' + 
                                '                    </div>' + 
                                '                    <div class="mui-numbox" data-numbox-step="1" data-numbox-min="0" data-numbox-max="999">' + 
                                '                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>' + 
                                '                        <input class="mui-numbox-input" type="number" value="' + 1 + '" id="numBoxVal' + res.costsId + '">' + 
                                '                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>' + 
                                '                    </div>' + 
                                '                </div>' + 
                                '                <div class="content-item" style="border: none;">' + 
                                '                    <div class="content-item textareaContainer" style="border: none;">' + 
                                '                        <textarea name="" id="" placeholder="请输入作业区域与内容" maxlength="100">' + remark + '</textarea>' + 
                                '                    </div>' + 
                                '                </div>' + 
                                '                <div class="addMore addMore' + sign + '">继续添加</div>' + 
                                '            </div>'
                            ).appendTo($('.costContainer'));

                            // 初始化进度条
                            initProgress('#myProgress' + res.costsId);

                            // 初始化numbox
                            mui('.mui-numbox').numbox();

                            // numbox数值改变逻辑
                            $('#numBoxVal' + res.costsId).on('change', function () {
                                var val = $('#numBoxVal' + res.costsId).val();

                                if (val == 0) {
                                    $('#item' + res.costsId).remove();
                                }
                                
                                $('#totalPrice' + res.costsId).text(floatMul(val, res.price * 1));
                                calcAllCost();
                                showAddMore();
                                changeMyArr();
                            });
                            
                            // 添加更多事件
                            $('.addMore' + sign).on('tap', function () {
                                addMore();
                            });
                            // 右侧箭头切换事件
                            $('.costArrow' + sign).on('tap', function () {
                                var id = $(this).attr('id');
                                changeCostsItem(this);
                            });
                            sign ++;
                        }
                        calcAllCost();
                        showAddMore();
                        changeMyArr();
                    }
                })
            }

            // 费用右侧箭头修改事件
            function changeCostsItem(changeArrow) {
                checkMyArr();
                var that = this;
                that.picker = new mui.PopPicker();
                that.picker.setData(myArr);
                that.picker.show(function (selectedItem) {
                    Util.ajax({
                        url: '/daily/getcostsitembycostsid',
                        data: {
                            costsId: selectedItem[0].value,
                            projectId: projectId
                        },
                        success: function (res) {
                            if (res.type * 1 == 0 || res.type * 1 == 1) {
                                remark = res.remark ? res.remark : '';
                                $(changeArrow).parent().parent().parent().html(  
                                    '                <div class="title">' + 
                                    '                    <div class="titleWord costsName">' + res.name + '</div>' + 
                                    '                    <div class="titleArrow"><span id=' + res.costsId + ' class="rightArrow costArrow costArrow' + sign + '">></span></div>' + 
                                    '                </div>' + 
                                    '                <div class="content-item flexBox">' + 
                                    '                    <div class="titleWord">' + 
                                    '                        <span class="rmbSymbol">￥</span><span class="rmbValue itemCost" id="totalPrice' + res.costsId + '">' + 1 * (res.price * 1) + '</span>' + 
                                    '                    </div>' + 
                                    '                    <div class="mui-numbox" data-numbox-step="0.5" data-numbox-min="0" data-numbox-max="999">' + 
                                    '                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>' + 
                                    '                        <input class="mui-numbox-input" type="number" value="' + 1 + '" id="numBoxValChange' + res.costsId + '">' + 
                                    '                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>' + 
                                    '                    </div>' + 
                                    '                </div>' + 
                                    '                <div class="content-item progressContent">' + 
                                    '                    <div class="titleWord">完成情况</div>' + 
                                    '                    <div class="mui-input-row mui-input-range" id="myProgress' + res.costsId + '">' + 
                                    '                        <input type="range" min="0" max="100" value="0">' + 
                                    '                        <div class="coverContent" id="myProgress' + res.costsId + 'coverContent"></div>' + 
                                    '                    </div>' + 
                                    '                </div>' + 
                                    '                <div class="content-item" style="border: none;">' + 
                                    '                    <div class="content-item textareaContainer" style="border: none;">' + 
                                    '                        <textarea name="" id="" placeholder="请输入工单任务说明" maxlength="100">' + remark + '</textarea>' + 
                                    '                    </div>' + 
                                    '                </div>' + 
                                    '                <div class="addMore addMore' + sign + '">继续添加</div>'
                                );

                                // 初始化进度条
                                initProgress('#myProgress' + res.costsId);

                                // 初始化numbox
                                mui('.mui-numbox').numbox();

                                // numbox数值改变逻辑
                                $('#numBoxValChange' + res.costsId).on('change', function () {
                                    var val = $('#numBoxValChange' + res.costsId).val();

                                    if (val == 0) {
                                        $(this).parent().parent().parent().remove();
                                    }

                                    $('#totalPrice' + res.costsId).text(floatMul(val, res.price * 1));
                                    calcAllCost();
                                    showAddMore();
                                    changeMyArr();
                                }); 

                                // 添加更多事件
                                $('.addMore' + sign).on('tap', function () {
                                    addMore();
                                });
                                // 右侧箭头切换事件
                                $('.costArrow' + sign).on('tap', function () {
                                    var id = $(this).attr('id');
                                    changeCostsItem(this);
                                });
                                sign ++;
                            }
                            if (res.type * 1 == 2 || res.type * 1 == 3) {
                                remark = res.remark ? res.remark : '';
                                $(changeArrow).parent().parent().parent().html(  
                                    '                <div class="title">' + 
                                    '                    <div class="titleWord costsName">' + res.name + '</div>' + 
                                    '                    <div class="titleArrow"><span id=' + res.costsId + ' class="rightArrow costArrow costArrow' + sign + '">></span></div>' + 
                                    '                </div>' + 
                                    '                <div class="content-item flexBoxSecond">' + 
                                    '                    <div class="titleWord">' + 
                                    '                        <span class="rmbSymbol">￥</span><span class="rmbValue itemCost" id="totalPrice' + res.costsId + '">' + 1 * (res.price * 1) + '</span>' + 
                                    '                    </div>' + 
                                    '                    <div class="mui-numbox" data-numbox-step="1" data-numbox-min="0" data-numbox-max="999">' + 
                                    '                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>' + 
                                    '                        <input class="mui-numbox-input" type="number" value="' + 1 + '" id="numBoxValChange' + res.costsId + '">' + 
                                    '                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>' + 
                                    '                    </div>' + 
                                    '                </div>' + 
                                    '                <div class="content-item" style="border: none;">' + 
                                    '                    <div class="content-item textareaContainer" style="border: none;">' + 
                                    '                        <textarea name="" id="" placeholder="请输入作业区域与内容" maxlength="100">' + remark + '</textarea>' + 
                                    '                    </div>' + 
                                    '                </div>' + 
                                    '                <div class="addMore addMore' + sign + '">继续添加</div>'
                                );

                                // 初始化进度条
                                initProgress('#myProgress' + res.costsId);

                                // 初始化numbox
                                mui('.mui-numbox').numbox();

                                // numbox数值改变逻辑
                                $('#numBoxValChange' + res.costsId).on('change', function () {
                                    var val = $('#numBoxValChange' + res.costsId).val();

                                    if (val == 0) {
                                        $(this).parent().parent().parent().remove();
                                    }
                                    
                                    $('#totalPrice' + res.costsId).text(floatMul(val, res.price * 1));
                                    calcAllCost();
                                    showAddMore();
                                    changeMyArr();
                                });
                                
                                // 添加更多事件
                                $('.addMore' + sign).on('tap', function () {
                                    addMore();
                                });
                                // 右侧箭头切换事件
                                $('.costArrow' + sign).on('tap', function () {
                                    var id = $(this).attr('id');
                                    changeCostsItem(this);
                                });
                                sign ++;
                            }
                            calcAllCost();
                            showAddMore();
                            changeMyArr();
                        }
                    })
                })
            }

            // 查询费用接口单价
            function getCostList() {
                Util.ajax({
                    url: '/daily/getcostsitem',
                    data: {
                        projectId: projectId
                    },
                    success: function (res) {
                        // console.log(JSON.stringify(res));
                        // 没有工单费用时的逻辑
                        var tempNum = 0;
                        for (var j = 0; j < res.length; j++) {
                            if (res[j].type * 1 == 0 && res[j].employment * 1 != 0) {
                                tempNum ++;
                            }
                        }
                        if (tempNum == 0) {
                            addMore();
                        }

                        var _loop = function _loop(i) {
                            // 工单用工
                            if (res[i].type * 1 == 0) {
                                if (res[i].employment * 1 != 0) {
                                    remark = res[i].remark ? res[i].remark : '';
                                    $(  
                                        '            <div class="item" id="item' + res[i].costsId + '">' + 
                                        '                <div class="title">' + 
                                        '                    <div class="titleWord costsName">' + res[i].name + '</div>' + 
                                        // '                    <div class="titleArrow"><span class="rightArrow">></span></div>'+
                                        '                </div>' + 
                                        '                <div class="content-item flexBox">' + 
                                        '                    <div class="titleWord">' + 
                                        '                        <span class="rmbSymbol">￥</span><span class="rmbValue itemCost" id="totalPrice' + res[i].costsId + '">' + res[i].employment * 1 * (res[i].price * 1) + '</span>' + 
                                        '                    </div>' + 
                                        '                    <div class="mui-numbox" data-numbox-step="0.5" data-numbox-min="0" data-numbox-max="999">' + 
                                        '                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>' + 
                                        '                        <input class="mui-numbox-input" type="number" value="' + res[i].employment + '" id="numBoxVal' + res[i].costsId + '">' + 
                                        '                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>' + 
                                        '                    </div>' + 
                                        '                </div>' + 
                                        '                <div class="content-item progressContent">' + 
                                        '                    <div class="titleWord">完成情况</div>' + 
                                        '                    <div class="mui-input-row mui-input-range" id="myProgress' + res[i].costsId + '">' + 
                                        '                        <input type="range" min="0" max="100" value="0">' + 
                                        '                        <div class="coverContent" id="myProgress' + res[i].costsId + 'coverContent"></div>' + 
                                        '                    </div>' + 
                                        '                </div>' + 
                                        '                <div class="content-item" style="border: none;">' + 
                                        '                    <div class="content-item textareaContainer" style="border: none;">' + 
                                        '                        <textarea name="" id="" placeholder="请输入工单任务说明" maxlength="100">' + remark + '</textarea>' + 
                                        '                    </div>' + 
                                        '                </div>' + 
                                        '                <div class="addMore addMore' + sign + '">继续添加</div>' + 
                                        '            </div>'
                                    ).appendTo($('.costContainer'));

                                    // 初始化进度条
                                    initProgress('#myProgress' + res[i].costsId); 

                                    // 初始化numbox
                                    mui('.mui-numbox').numbox();

                                    // numbox数值改变逻辑
                                    $('#numBoxVal' + res[i].costsId).on('change', function () {
                                        // console.log(res[i].price);
                                        var val = $('#numBoxVal' + res[i].costsId).val();

                                        if (val == 0) {
                                            $('#item' + res[i].costsId).remove();
                                        }
                                        
                                        $('#totalPrice' + res[i].costsId).text(floatMul(val, res[i].price * 1));
                                        calcAllCost();
                                        showAddMore();
                                        changeMyArr();
                                    }); 
                                    
                                    // 添加更多事件
                                    $('.addMore' + sign).on('tap', function () {
                                        addMore();
                                    });
                                    sign ++;
                                }
                            }
                        }

                        for (var i = 0; i < res.length; i++) {
                            var remark;
                            var remark;
                            var remark;
                            _loop(i);
                        }
                        calcAllCost();
                        showAddMore();
                        changeMyArr();
                    }
                })
            }
            getCostList();

            // 提交事件
            $('#submitBtn').on('tap', function () {
                var images = '';
                $("img.mui-img-upload","#imgList").each(function(i){
                    var id = $(this).attr("id");
                    if(i != 0){ 
                        images += ",";
                    }
                    images += id;
                });
                var flexBox = $('.flexBox');
                var flexBoxSecond = $('.flexBoxSecond');
                var otherItem = $('.otherItem');
                var human = [];
                var costs = [];
                var problems = [];
                for (var i = 0; i < flexBox.length; i++) {
                    var tempObj = {
                        // 编号
                        costsId: $(flexBox[i]).find('input').attr('id').substr(9),
                        //用工数
                        amount: $(flexBox[i]).find('input').val(),
                        // 工单任务说明,
                        job: $(flexBox[i]).parent().find('textarea').val(),
                        //完成情况
                        progress: $(flexBox[i]).parent().find('.progressContent').find('input').val()
                    };
                    human.push(tempObj);
                }
                for (var i = 0; i < flexBoxSecond.length; i++) {
                    var tempObj = {
                        // 编号
                        costsId: $(flexBoxSecond[i]).find('input').attr('id').substr(9),
                        //用工数
                        amount: $(flexBoxSecond[i]).find('input').val(),
                        // 工单任务说明,
                        job: $(flexBoxSecond[i]).parent().find('textarea').val()
                    };
                    costs.push(tempObj);
                }
                for (var i = 0; i < otherItem.length; i++) {
                    var type = '';
                    if ($(otherItem[i]).find('.problemItem').text() == '人员') {
                        type = '1';
                    } else if ($(otherItem[i]).find('.problemItem').text() == '机械') {
                        type = '2';
                    } else if ($(otherItem[i]).find('.problemItem').text() == '材料') {
                        type = '3';
                    }
                    var tempObj = {
                        type: type,
                        problemDesc: $(otherItem[i]).find('textarea').val()
                    }
                    problems.push(tempObj);
                }
                // console.log(JSON.stringify(human));
                // console.log(JSON.stringify(costs));
                // console.log(JSON.stringify(problems));
                var security = $('#safeRecord').val();
                var plan = $('#tomorrowPlan').val();
                var daily = {
                    projectId: projectId,
                    security: security,
                    plan: plan
                }
                mui.confirm('是否提交日报？', '提示', ['否', '是'], function(e) {
                    var submitDOM = document.getElementById('submitBtn');
                    submitDOM.disabled = true;
                    if (e.index == 1) {
                        Util.ajax({
                            url: '/daily/savedailyinfo',
                            type: 'post',
                            data: {
                                daily: daily,
                                costs: costs,
                                human: human,
                                problems: problems,
                                images: images,
                                isyesterday: isyesterday
                            },
                            success: function (res){
                                mui.openWindow({
                                    url: './actionResult.html', 
                                    id:'actionResult',
                                    extras:{
                                        actionId: '9'
                                    }
                                });
                            },
                            error: function (res) {
                                console.log(JSON.stringify(res))
                            }
                        })
                    } else {
                        submitDOM.disabled = false;
                    }
                })
            })




            mui("body").on("tap", ".imageup", function () {
                page.imgUp();
            });
            var page = null;
            page = {
                imgUp: function () {
                    var m = this;
                    plus.nativeUI.actionSheet({
                        cancel: "取消", buttons: [
                            { title: "拍照" },
                            { title: "从相册中选择" }
                        ]
                    }, function (e) {//1 是拍照  2 从相册中选择  
                        switch (e.index) {
                            case 1: appendByCamera(); break;
                            case 2: appendByGallery(); break;
                        }
                    });
                }
            }


            // 上传文件
            function upload(url) {
                var server = app.configures.URL + "/iPark/APIs/resources/uploadimage?type=IMI&longitude=" + lng + "&latitude=" + lat;
                console.log(url);
                var wt = plus.nativeUI.showWaiting();
                var task = plus.uploader.createUpload(server,
                    { method: "POST" },
                    function (t, status) { //上传完成
                        if (status == 200) {
                            var response = JSON.parse(t.responseText);
                            var imgId = response.id;
                            var imgurl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMinimal;
                            var mediumImgUrl = app.configures.URL + "/iPark/APIs/maintGuide/getImageByPath?imagePath=" + response.resourceMedium;
                            html = "<a class='imgItem' href='javascript:void(0);'><img class='mui-img-uni' src='../images/close.png'/><img class='mui-img-upload' id='" + imgId + "' data-src='" + mediumImgUrl + "' src='" + imgurl + "'/></a>";
                            jQuery("#imgList").append(html);
                            check();//检查上传图片的个数
                            wt.close(); //关闭等待提示按钮
                            jQuery(".mui-img-upload").off();
                            jQuery(".mui-img-upload").on("click", function () {
                                var src = jQuery(this).data('src');
                                var result = "<img src='" + src + "'/>";
                                jQuery("#backdrop").attr('class', 'mui-backdrop').html(result).show();
                            });
                            jQuery("#backdrop").off();
                            jQuery("#backdrop").on("click", function () {
                                jQuery("#backdrop").attr('class', '').html('').hide();
                            });
                        } else {
                            alert("上传失败：" + status);
                            wt.close();//关闭等待提示按钮
                        }
                    }
                );
                //添加其他参数
                task.addData("name", "file");
                task.addFile(url, { key: "file" });
                task.start();
            }
            // 拍照添加文件
            function appendByCamera() {
                plus.camera.getCamera().captureImage(function (e) {
                    console.log(e);
                    plus.io.resolveLocalFileSystemURL(e, function (entry) {
                        var path = entry.toLocalURL();
                        baiduPosition(path);
                    }, function (e) {
                        mui.toast("读取拍照文件错误：" + e.message);
                    });

                });
            }
            // 从相册添加文件
            function appendByGallery() {
                plus.gallery.pick(function (path) {
                    //okdocument.getElementById("headimg").src = path;
                    baiduPosition(path);
                });
            }
            //获取经纬度
            function baiduPosition(path) {
                plus.geolocation.getCurrentPosition(function (e) {
                    lng = e.coords.longitude;
                    lat = e.coords.latitude;
                    upload(path);
                }, function (e) {
                    var geolocation = new BMap.Geolocation();
                    geolocation.getCurrentPosition(function (r) {
                        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                            lng = r.point.lng;
                            lat = r.point.lat;
                            upload(path);
                        } else {
                            mui.alert('获取位置失败,请确定您已开启定位服务');
                        }
                    }, { enableHighAccuracy: true });
                }, { enableHighAccuracy: true, coordsType: 'bd09ll', timeout: 6000, maximumAge: 5000, provider: 'baidu' });

            }
            //检查上传图片的个数
            function check() {
                var length = jQuery('#imgList').children('.imgItem').length;
                if (length >= 5) {
                    jQuery('#imgList .imageup').hide();
                } else {
                    jQuery('#imgList .imageup').show();
                }
            }
            // 删除图片
            jQuery('body').on('tap', '.mui-img-uni', function () {
                jQuery(this).parent('.imgItem').remove();
                check();
            });
        });


        // 数组去值
        function removeByValue(arr, val) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == val) {
                    arr.splice(i, 1);
                    break;
                }
            }
        }

        // 加
        function floatAdd(arg1, arg2) {
            var r1, r2, m;
            try { r1 = arg1.toString().split(".")[1].length } catch (e) { r1 = 0 }
            try { r2 = arg2.toString().split(".")[1].length } catch (e) { r2 = 0 }
            m = Math.pow(10, Math.max(r1, r2));
            return (arg1 * m + arg2 * m) / m;
        }

        // 乘
        function floatMul(arg1, arg2) {
            var m = 0, s1 = arg1.toString(), s2 = arg2.toString();
            try { m += s1.split(".")[1].length } catch (e) { }
            try { m += s2.split(".")[1].length } catch (e) { }
            return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
        }
    </script>
</body>

</html>